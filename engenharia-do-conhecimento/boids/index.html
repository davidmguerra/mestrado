<body style="margin: 0">
  <div id="boids">
  </div>
</body>

<script src="p5.min.js" type="text/javascript"></script>
<script type="text/javascript">
  
  class Passaro {

    // Inicializa os parâmetros
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.aceleracao = createVector(0, 0);
      this.velocidade = createVector(random(-1, 1), random(-1, 1));
      this.posicao = createVector(x, y);
      this.velocidadeMaxima = 2;
      this.forcaMaxima = 0.03;
    }

    // Desloca o pássaro conforme análise de separação, alinhamento e coesão
    movimentar(passaros) {
      this.analisarVizinhanca(passaros);
      this.atualizarPosicao();
      this.verificarLimites();
      this.renderizar();
    }

    // Verifica a influência dos pássaros vizinhos e adiciona na aceleração
    analisarVizinhanca(passaros) {
      this.aceleracao.add(this.separacao(passaros));
      this.aceleracao.add(this.alinhamento(passaros));
      this.aceleracao.add(this.coesao(passaros));
    }

    // Atualiza a posição do pássaro
    atualizarPosicao() {
      this.velocidade.add(this.aceleracao);
      this.velocidade.limit(this.velocidadeMaxima);
      this.posicao.add(this.velocidade);
      this.aceleracao.mult(0);
    }

    // Calcula e aplica uma força em direção ao pássaro verificado
    aplicarForcaPassaro(passaro) {
      var desired = p5.Vector.sub(passaro, this.posicao);
      desired.normalize();
      desired.mult(this.velocidadeMaxima);
      var steer = p5.Vector.sub(desired, this.velocidade);
      steer.limit(this.forcaMaxima);
      return steer;
    }

    // Renderiza os pássaros no canvas
    renderizar() {
      var theta = this.velocidade.heading() + radians(90);
      fill(200, 100);
      stroke(255);
      push();
      translate(this.posicao.x, this.posicao.y);
      rotate(theta);
      beginShape();
      image(passarosImg[Math.floor(random(0,7.99))], 0, this.height / 2, 15, 15);
      endShape(CLOSE);
      pop();
    }

    // Verifica se a posição do pássaro ficou fora do canvas
    verificarLimites = function () {
      if (this.posicao.x < 0) this.posicao.x = width;
      if (this.posicao.y < 0) this.posicao.y = height;
      if (this.posicao.x > width) this.posicao.x = 0;
      if (this.posicao.y > height) this.posicao.y = 0;
    }

    // Verifica os pássaros ao reder e se afasta
    separacao(passaros) {
      var desiredseparation = 25.0;
      var steer = createVector(0, 0);
      var count = 0;
      // Verifica se os passaros estão muito próximos
      passaros.forEach(passaro => {
        var distancia = p5.Vector.dist(this.posicao, passaro.posicao);
        if (passaro != this && distancia < desiredseparation) {
          var diff = p5.Vector.sub(this.posicao, passaro.posicao);
          diff.normalize();
          diff.div(distancia);
          steer.add(diff);
          count++;
        }
      });
      // Calcula a média
      if (count > 0) {
        steer.div(count);
      }

      if (steer.mag() > 0) {
        // Reynolds: Steering = Desired - Velocity
        steer.normalize();
        steer.mult(this.velocidadeMaxima);
        steer.sub(this.velocidade);
        steer.limit(this.forcaMaxima);
      }
      return steer;
    }

    // Calcular a velocidade média de cada pássaro
    alinhamento(passaros) {
      var neighbordist = 50;
      var sum = createVector(0, 0);
      var count = 0;
      passaros.forEach(passaro => {
        var d = p5.Vector.dist(this.posicao, passaro.posicao);
        if ((d > 0) && (d < neighbordist)) {
          sum.add(passaro.velocidade);
          count++;
        }
      });
      if (count > 0) {
        sum.div(count);
        sum.normalize();
        sum.mult(this.velocidadeMaxima);
        var steer = p5.Vector.sub(sum, this.velocidade);
        steer.limit(this.forcaMaxima);
        return steer;
      } else {
        return createVector(0, 0);
      }
    }

    // Para a localização média (ou seja, centro) de todos os boids próximos, calcule o vetor de direção em direção a esse local
    coesao(passaros) {
      var neighbordist = 50;
      var sum = createVector(0, 0);   // Start with empty vector to accumulate all locations
      var count = 0;
      passaros.forEach(passaro => {
        var d = p5.Vector.dist(this.posicao, passaro.posicao);
        if ((d > 0) && (d < neighbordist)) {
          sum.add(passaro.posicao);
          count++;
        }
      });
      if (count > 0) {
        sum.div(count);
        return this.aplicarForcaPassaro(sum);
      } else {
        return createVector(0, 0);
      }
    }
  }

  class Bando {

    passaros = [];

    movimentar() {
      this.passaros.forEach(passaro => {
        passaro.movimentar(this.passaros);
      });
    }

    adicionarPassaro(b) {
      this.passaros.push(b);
    }

  }
  
  const width = document.documentElement.clientWidth;
  const heightCanvas = document.documentElement.clientHeight-50;
  const height = heightCanvas*2/3.1;

  var passarosImg = [];

  var bando;

  function setup() {
    [1,2,3,4,5,6,7,8].forEach(b => passarosImg.push(loadImage('img/' + b + '.png')));
    var canvas = createCanvas(width, heightCanvas);
    canvas.parent("boids"); // Adiciona a imgagem no DIV

    bando = new Bando();
    for (var i = 0; i < 150; i++) { // Cria 150 elementos no centro da imagem
      bando.adicionarPassaro(new Passaro(Math.random() * width, 0));
    }
  }

  function draw() {

    let canvas = document.querySelector('#boids canvas');
    var ctx = canvas.getContext('2d');

    // Cria gradientes
    var ceu = ctx.createLinearGradient(0, heightCanvas-height, 0, heightCanvas);
    ceu.addColorStop(0, '#00ABEB');
    ceu.addColorStop(0.5, '#fff');
    ceu.addColorStop(0.5, '#26C000');
    ceu.addColorStop(1, '#fff');

    var gramado = ctx.createLinearGradient(0, 50, 0, 95);
    gramado.addColorStop(0.5, '#000');
    gramado.addColorStop(1, 'rgba(0, 0, 0, 0)');

    // Atribui gradientes para preencher e traçar estilos
    ctx.fillStyle = ceu;
    ctx.strokeStyle = gramado;
    
    // Renderiza os elementos
    ctx.fillRect(0, 0, width, heightCanvas);

    bando.movimentar();

  }

  // Adiciona um pássaro no local do click
  function mousePressed() {
    bando.adicionarPassaro(new Passaro(mouseX, mouseY));
  }

</script>